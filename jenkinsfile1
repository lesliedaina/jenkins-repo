pipeline {
    agent {
       label ("leslie-agent")
    }
    environment{
        DOCKERHUB_CREDENTIALS=credentials('dockerhub')
    }
        
    
    stages{

        stage('cleaning '){
            steps{
                
                sh '''
                docker rmi -f $(docker ps -aq) || true
                
                '''
            }
        }
    
    
          stage('build docker image'){
            steps{
                
                sh '''
                docker build -t leslie1/jenkins-repo .
        
                '''
            }
          }  

         stage('tag my image'){
                steps{
                    sh'''
                    docker tag leslie1/jenkins-repo leslie1/jenkins-repo:V1
                    '''
                }
            }


         stage ('login to docker hub'){
                steps{
                    
                   sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
                }
            }    
  


         stage ('push image to dockerhub'){
                steps{
                    sh'''
                    docker push leslie1/jenkins-repo:V1
                    '''
                }
            }
         


         

         stage ('deployment'){
            steps{
                sh'''
                kubectl apply -f deployment.yaml
                '''
            }
        }







                                  
        }
    
    }

   



